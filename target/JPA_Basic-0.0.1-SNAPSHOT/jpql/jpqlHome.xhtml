<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html >
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
  <!-- h:headタグ -->
  <h:head>
  <title>JPQLホーム</title>
  </h:head>
  <h:body>

    <!-- jsファイルインポート -->
    <h:outputScript library="js" name="jpqlScript.js" target="body" />

    <h:outputStylesheet library="css" name="jpqlStyle.css" />

    <h1>JPQLホーム</h1>

    <br />

    <!-- Todo追加フォーム展開ボタン -->
    <button type="button" onclick="openAddForm()" id="openAddForm">Todo追加</button>

    <!-- Todo追加フォーム -->
    <h:form id="addForm">
        <h3>Todo追加フォーム</h3>

        <h:outputLabel for="todo" value="todo:" /><br />
        <h:inputText value="#{jpqlBackingBean.todoDto.todo}" id="todo" /><br /><br />

        <h:outputLabel for="priority" value="priority:" /><br />
        <h:selectOneMenu value="#{jpqlBackingBean.todoDto.priority}" id="priority">
            <f:selectItem itemLabel="低" itemValue="低" />
            <f:selectItem itemLabel="中" itemValue="中" />
            <f:selectItem itemLabel="高" itemValue="高" />
        </h:selectOneMenu><br /><br />

        <h:outputLabel for="detail" value="detail:" /><br />
        <h:inputTextarea value="#{jpqlBackingBean.todoDto.detail}" id="detail" rows="4" cols="40" /><br /><br />

        <h:outputLabel for="userId" value="割当先ユーザー:" /><br />
        <h:selectOneMenu id="userId" value="#{jpqlBackingBean.todoDto.accountDto.userId}">
            <f:selectItems value="#{jpqlBackingBean.getAccountList}"
                                    var="account"
                                    itemValue="#{account.userId}"
                                    itemLabel="#{account.username}" />
        </h:selectOneMenu><br /><br />

       <h:commandButton value="確認へ">
            <f:ajax execute="@form" render="addComfirm"  onevent="afterAddForm"/>
       </h:commandButton>
    </h:form>

     <!-- Todo確認フォーム -->
    <h:form id="addComfirm">
        <h3>以下Todoを追加しますか？</h3>

        <h:outputLabel for="comfirmTodo" value="todo:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.todo}" id="comfirmTodo" /><br /><br />

        <h:outputLabel for="comfirmPriority" value="priority:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.priority}" id="comfirmPriority" /><br /><br />

        <h:outputLabel for="comfirmDetail" value="detail:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.detail}" id="comfirmDetail" /><br /><br />

        <h:outputLabel for="comfirmUserId" value="割当先ユーザーID:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.accountDto.userId}" id="comfirmUserId" /><br /><br />

        <h:commandButton value="追加" action="#{jpqlBackingBean.insertTodo()}" />
    </h:form>

    <br /><br />

    <h3>JPQLで全件取得</h3>
    <h:outputText value="#{jpqlBackingBean.getList.size()}件のレコード" /><br />
    <table id="getList" border="1">
        <tr>
            <th>TodoID</th>
            <th>Todo</th>
            <th>優先度</th>
            <th>詳細</th>
            <th>割当先ユーザーID</th>
            <th>割当先ユーザー名</th>
            <th>更新</th>
            <th>削除</th>
        </tr>
        <ui:repeat var="row" value="#{jpqlBackingBean.getList}">
            <tr>
                <td><h:outputText value="#{row.id}" /></td>
                <td><h:outputText value="#{row.todo}" /></td>
                <td><h:outputText value="#{row.priority}" /></td>
                <td><h:outputText value="#{row.detail}" /></td>
                <td><h:outputText value="#{row.accountDto.userId}" /></td>
                <td><h:outputText value="#{row.accountDto.username}" /></td>
                <td>
                    <h:form>
                        <h:commandButton value="更新" action="#{jpqlBackingBean.findById()}">
                            <!-- コマンドボタン押印時にバッキングビーンのtodo.idにrow.idをセット -->
                            <f:setPropertyActionListener target="#{jpqlBackingBean.todoDto.id}" value="#{row.id}" />
                            <f:ajax execute="@form" render="updateForm"  onevent="openUpdateForm"/>
                        </h:commandButton>
                    </h:form>
                </td>
                <td>
                    <h:form>
                        <h:commandButton value="削除" action="#{jpqlBackingBean.findById()}">
                            <f:setPropertyActionListener target="#{jpqlBackingBean.todoDto.id}" value="#{row.id}" />
                            <f:ajax execute="@form" render="deleteComfirm"  onevent="openDeleteComfirm"/>
                        </h:commandButton>
                    </h:form>
                </td>
            </tr>
        </ui:repeat>
    </table>

    <!-- Todo更新フォーム -->
    <h:form id="updateForm">
        <h3>Todo更新フォーム</h3>

        <h:outputLabel for="todo" value="todo:" /><br />
        <h:inputText value="#{jpqlBackingBean.todoDto.todo}" id="todo" /><br /><br />

        <h:outputLabel for="priority" value="priority:" /><br />
        <h:selectOneMenu value="#{jpqlBackingBean.todoDto.priority}" id="priority">
            <f:selectItem itemLabel="低" itemValue="低" />
            <f:selectItem itemLabel="中" itemValue="中" />
            <f:selectItem itemLabel="高" itemValue="高" />
        </h:selectOneMenu><br /><br />

        <h:outputLabel for="detail" value="detail:" /><br />
        <h:inputTextarea value="#{jpqlBackingBean.todoDto.detail}" id="detail" rows="4" cols="40" /><br /><br />

        <h:outputLabel for="userId" value="割当先ユーザー:" /><br />
        <h:selectOneMenu id="userId" value="#{jpqlBackingBean.todoDto.accountDto.userId}">
            <f:selectItems value="#{jpqlBackingBean.getAccountList}"
                                    var="account"
                                    itemValue="#{account.userId}"
                                    itemLabel="#{account.username}" />
        </h:selectOneMenu><br /><br />

       <h:commandButton value="確認へ">
            <f:ajax execute="@form" render="updateComfirm"  onevent="afterUpdateForm"/>
       </h:commandButton>
    </h:form>

    <!-- Todo更新確認 -->
    <h:form id="updateComfirm">
        <h3><h:outputText value="以下をTodoを更新しますか？" /></h3>

        <h:outputLabel for="comfirmTodo" value="todo:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.todo}" id="comfirmTodo" /><br /><br />

        <h:outputLabel for="comfirmPriority" value="priority:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.priority}" id="comfirmPriority" /><br /><br />

        <h:outputLabel for="comfirmDetail" value="detail:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.detail}" id="comfirmDetail" /><br /><br />

        <h:outputLabel for="comfirmUserId" value="割当先ユーザーID:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.accountDto.userId}" id="comfirmUserId" /><br /><br />

        <h:commandButton value="更新" action="#{jpqlBackingBean.updateTodo()}" />
    </h:form>

    <!-- Todo削除確認 -->
    <h:form id="deleteComfirm">
        <h3><h:outputText value="以下をTodoを削除しますか？" /></h3>

        <h:outputLabel for="comfirmTodo" value="todo:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.todo}" id="comfirmTodo" /><br /><br />

        <h:outputLabel for="comfirmPriority" value="priority:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.priority}" id="comfirmPriority" /><br /><br />

        <h:outputLabel for="comfirmDetail" value="detail:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.detail}" id="comfirmDetail" /><br /><br />

        <h:outputLabel for="comfirmUserId" value="割当先ユーザーID:" /><br />
        <h:outputText value="#{jpqlBackingBean.todoDto.accountDto.userId}" id="comfirmUserId" /><br /><br />

        <h:commandButton value="削除" action="#{jpqlBackingBean.deleteTodo()}" />
    </h:form>

    <br /><br />


    <h3>JPQLで全件取得（NamedQuery使用版）</h3>
    <h:outputText value="#{jpqlBackingBean.getListByNamedQuery.size()}件のレコード" /><br />
    <table id="getListByNamedQuery" border="1">
        <tr>
            <th>TodoID</th>
            <th>Todo</th>
            <th>優先度</th>
            <th>詳細</th>
            <th>割当先ユーザーID</th>
            <th>割当先ユーザー名</th>
        </tr>
        <ui:repeat var="row" value="#{jpqlBackingBean.getListByNamedQuery}">
            <tr>
                <td><h:outputText value="#{row.id}" /></td>
                <td><h:outputText value="#{row.todo}" /></td>
                <td><h:outputText value="#{row.priority}" /></td>
                <td><h:outputText value="#{row.detail}" /></td>
                <td><h:outputText value="#{row.accountDto.userId}" /></td>
                <td><h:outputText value="#{row.accountDto.username}" /></td>
            </tr>
        </ui:repeat>
    </table>

    <br /><br />


    <h3>JPQLで取集約関数利用</h3>
    <h:outputText value="#{jpqlBackingBean.aggregateByUserId.size()}件のレコード" /><br />
    <table id="aggregateByUserId" border="1">
        <tr>
            <th>割当先ユーザーID</th>
            <th>割当先ユーザー名</th>
            <th>ユーザー別最小TodoID</th>
            <th>ユーザー別最大TodoID</th>
            <th>ユーザー別Todo合計</th>
        </tr>
        <ui:repeat var="row" value="#{jpqlBackingBean.aggregateByUserId}">
            <tr>
                <td><h:outputText value="#{row.accountDto.userId}" /></td>
                <td><h:outputText value="#{row.accountDto.username}" /></td>
                <td><h:outputText value="#{row.min}" /></td>
                <td><h:outputText value="#{row.max}" /></td>
                <td><h:outputText value="#{row.count}" /></td>
            </tr>
        </ui:repeat>
    </table>


    <br /><br />


    <h3>JPA×ネイティブSQL×ウィンドウ関数</h3>
    <h:outputText value="#{jpqlBackingBean.useWindowFunction.size()}件のレコード" /><br />
    <table id="useWindowFunction" border="1">
        <tr>
            <th>TodoID</th>
            <th>Todo</th>
            <th>優先度</th>
            <th>詳細</th>
            <th>割当先ユーザーID</th>
            <th>割当先ユーザー名</th>
            <th>ユーザー別タスクランク</th>
        </tr>
        <ui:repeat var="row" value="#{jpqlBackingBean.useWindowFunction}">
            <tr>
                <td><h:outputText value="#{row.id}" /></td>
                <td><h:outputText value="#{row.todo}" /></td>
                <td><h:outputText value="#{row.priority}" /></td>
                <td><h:outputText value="#{row.detail}" /></td>
                <td><h:outputText value="#{row.accountDto.userId}" /></td>
                <td><h:outputText value="#{row.accountDto.username}" /></td>
                <td><h:outputText value="#{row.userrank}" /></td>
            </tr>
        </ui:repeat>
    </table>

  </h:body>
</html>